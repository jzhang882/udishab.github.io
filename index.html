<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body{
        background-color: #050F47;
    }
</style>
<head>
    <title>Obesity by State</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="../lib/d3-geo-projection.v2.smin.js"></script>
    <script type="text/javascript" src="../lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="../lib/d3-tip.min.js"></script>
	<style>
        .d3-tip {
            line-height: 1.3;
            font-weight: 100;
            background: rgba(255, 255, 255, 0.7);
            color: #050f47;
            pointer-events: none;
        }
    </style>
</head>

<body style="font-family: monospace; color: white">
<h1>Predicting Percentage of Obese Individuals by State</h1>

<!-- CheckBox -->
<div>
<label>Select Predictor Variables: </label>
<input type="checkbox" class="predvar" value="m"><label>Mental Health</label>
<input type="checkbox" class="predvar" value="p"><label>Physical Health</label>
<input type="checkbox" class="predvar" value="i"><label>Income</label>
<input type="checkbox" class="predvar" value="n"><label>Nutrition</label>
<input type="checkbox" class="predvar" value="s"><label>Smoking</label>
<input type="checkbox" class="predvar" value="a"><label>Alcohol</label>
</div>

<script>

// svg
var w = 600
var h = 450
var th = h/10

var svg = d3.select("body").append("svg").attr("width", w).attr("height", h);
var svg2 = d3.select("body").append("svg").attr("width", w).attr("height", h);
var svg3 = d3.select("body").append("svg").attr("width", w*2).attr("height", th);

// color scale
qScale = d3.scaleQuantile().domain([.22,.38]).range(['#bbdefb', '#64b5f6', '#1e88e5', '#0d47a1'])
    // '#88cdf6',"#5dbcd2","#2d82b5","#015c92"])

// projection and path
var projection = d3.geoAlbersUsa().translate([w/2, h/2]).scale([800])
var path = d3.geoPath().projection(projection)

// data read
Promise.all([
d3.json("us-states.json"),
d3.dsv(",", "out.csv", function (d) {
    return {
        state: d.State,
        act: d.Actual,
        mpred: d["_MENTHLTH"],
        ppred: d["_PHYSHLTH"],
        ipred: d["_INCOME2"],
        npred: d["_VEG"],
        spred: d["_SMOKDAY2"],
        apred: d["_ALCDAY5"],
        mppred: d["_MENTHLTH_PHYSHLTH"],
        mspred: d["_MENTHLTH_SMOKDAY2"],
        mapred: d["_MENTHLTH_ALCDAY5"],
        mipred: d["_MENTHLTH_INCOME2"],
        mnpred: d["_MENTHLTH_VEG"],
        pspred: d["_PHYSHLTH_SMOKDAY2"],
        papred: d["_PHYSHLTH_ALCDAY5"],
        pipred: d["_PHYSHLTH_INCOME2"],
        pnpred: d["_PHYSHLTH_VEG"],
        sapred: d["_SMOKDAY2_ALCDAY5"],
        ispred: d["_SMOKDAY2_INCOME2"],
        nspred: d["_SMOKDAY2_VEG"],
        iapred: d["_ALCDAY5_INCOME2"],
        napred: d["_ALCDAY5_VEG"],
        inpred: d["_INCOME2_VEG"],
        mpspred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2"],
        mpapred: d["_MENTHLTH_PHYSHLTH_ALCDAY5"],
        mpipred: d["_MENTHLTH_PHYSHLTH_INCOME2"],
        mpnpred: d["_MENTHLTH_PHYSHLTH_VEG"],
        msapred: d["_MENTHLTH_SMOKDAY2_ALCDAY5"],
        mispred: d["_MENTHLTH_SMOKDAY2_INCOME2"],
        mnspred: d["_MENTHLTH_SMOKDAY2_VEG"],
        miapred: d["_MENTHLTH_ALCDAY5_INCOME2"],
        mnapred: d["_MENTHLTH_ALCDAY5_VEG"],
        minpred: d["_MENTHLTH_INCOME2_VEG"],
        psapred: d["_PHYSHLTH_SMOKDAY2_ALCDAY5"],
        pispred: d["_PHYSHLTH_SMOKDAY2_INCOME2"],
        pnspred: d["_PHYSHLTH_SMOKDAY2_VEG"],
        piapred: d["_PHYSHLTH_ALCDAY5_INCOME2"],
        pnapred: d["_PHYSHLTH_ALCDAY5_VEG"],
        pinpred: d["_PHYSHLTH_INCOME2_VEG"],
        isapred: d["_SMOKDAY2_ALCDAY5_INCOME2"],
        nsapred: d["_SMOKDAY2_ALCDAY5_VEG"],
        inspred: d["_SMOKDAY2_INCOME2_VEG"],
        inapred: d["_ALCDAY5_INCOME2_VEG"],
        mpsapred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_ALCDAY5"],
        mpispred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_INCOME2"],
        mpnspred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_VEG"],
        mpiapred: d["_MENTHLTH_PHYSHLTH_ALCDAY5_INCOME2"],
        mpnapred: d["_MENTHLTH_PHYSHLTH_ALCDAY5_VEG"],
        mpinpred: d["_MENTHLTH_PHYSHLTH_INCOME2_VEG"],
        misapred: d["_MENTHLTH_SMOKDAY2_ALCDAY5_INCOME2"],
        mnsapred: d["_MENTHLTH_SMOKDAY2_ALCDAY5_VEG"],
        minspred: d["_MENTHLTH_SMOKDAY2_INCOME2_VEG"],
        minapred: d["_MENTHLTH_ALCDAY5_INCOME2_VEG"],
        pisapred: d["_PHYSHLTH_SMOKDAY2_ALCDAY5_INCOME2"],
        pnsapred: d["_PHYSHLTH_SMOKDAY2_ALCDAY5_VEG"],
        pinspred: d["_PHYSHLTH_SMOKDAY2_INCOME2_VEG"],
        pinapred: d["_PHYSHLTH_ALCDAY5_INCOME2_VEG"],
        insapred: d["_SMOKDAY2_ALCDAY5_INCOME2_VEG"],
        mpisapred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_ALCDAY5_INCOME2"],
        mpnsapred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_ALCDAY5_VEG"],
        mpinspred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_INCOME2_VEG"],
        mpinapred: d["_MENTHLTH_PHYSHLTH_ALCDAY5_INCOME2_VEG"],
        minsapred: d["_MENTHLTH_SMOKDAY2_ALCDAY5_INCOME2_VEG"],
        pinsapred: d["_PHYSHLTH_SMOKDAY2_ALCDAY5_INCOME2_VEG"],
        mpinsapred: d["_MENTHLTH_PHYSHLTH_SMOKDAY2_ALCDAY5_INCOME2_VEG"]
      };
    })
]).then(function (data) {
      pageSetup(data[0],data[1])}
);

function pageSetup(states, obesityData){
    //var obdt = []
    //for (s of obesityData) {obdt.push(s.act)}
    //qScale.domain(obdt)
    svg.append("text")
        .attr("x", w/2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .text("Your Map")
        .style("fill", "white");
    svg2.append("text")
        .attr("x", w/2)
        .attr("y", 50)
        .attr("text-anchor", "middle")
        .text("True Map")
        .style("fill", "white");
    svg2.append("g")
        .attr("transform","translate("+(w-160)+",5)")
        .call(d3.legendColor()
        .labelFormat(d3.format(".0%"))
        .scale(qScale))
        .style("fill", "white")
    svg2.append("g")
        .selectAll("path")
        .data(states.features).enter()
        .append("path")
        .attr("d", path)
        .attr("id", function(d) {return d.properties.name.replace(/\s/g,'')})
        .style('stroke', 'white')
        .style('stroke-width', 1)
        .style('fill','grey')

    for (x of obesityData) {
        svg2.select("#"+x.state.replace(/\s/g,'')).style("fill",function(d) {return qScale(x.act);})
    }
    obesityMap(states,obesityData,'pred')
    d3.selectAll(".predvar").on("change",function(){stringcat(states,obesityData)});
}

function stringcat(states,obesityData){
    selections = ''
    d3.selectAll(".predvar").each(function(d){
          if(d3.select(this).property("checked")){
            selections += d3.select(this).property("value");
          }
        });
    selections += 'pred'
    obesityMap(states,obesityData,selections)
}

function obesityMap(states,obesityData,selections){
    d3.selectAll(".temp").remove()

    // enter code to define tooltip
    var tip = d3.tip().attr('class', 'd3-tip').html(function(d) {
        predicted = '';
        actual = '';
        if (selections == 'pred') {
            predicted = '--';
            actual = '--'
        } else {
            for (x of obesityData) {
                if (x.state == d.properties.name) {
                    predicted = (Number(x[selections]) * 100).toFixed(2)
                    actual = (Number(x.act) * 100).toFixed(2)
                    break;
                }
            }
        }
        return "<strong>State: </strong><span class='details'>" + d.properties.name + "<br></span>" +
            "<strong>Predicted: </strong><span class='details'>" + predicted + "%<br></span>" +
            "<strong>Actual: </strong><span class='details'>" + actual + "%<br></span>";
    });
    svg.call(tip);

    svg.append("g")
        .selectAll("path")
        .data(states.features).enter()
        .append("path")
        .attr("d", path)
        .attr("class","temp")
        .attr("id", function(d) {return d.properties.name.replace(/\s/g,'')})
        .style('stroke', 'red')
        .style('stroke-width', 1.5)
        .style('fill','white')
        .on('mouseover',function(d){
            tip.show(d);
            d3.select(this)
                .style('opacity', .95)
                .style('stroke-width', 2);
        })
        .on('mouseout', function(d){
            tip.hide(d);
            d3.select(this)
                .style('opacity', 1)
                .style('stroke-width', 1);
        })
    for (x of obesityData) {
        svg.select("#"+x.state.replace(/\s/g,''))
            .style("fill",function(d) {
                return qScale(x[selections]);
            })
            .attr("obesitycat",function(d) {return qScale(x[selections])})
        if (qScale(x.act) == qScale(x[selections]))
            svg.select("#"+x.state.replace(/\s/g,''))
                .style("stroke", "white")
                .style("stroke-width", "1.1")
    }
    match(obesityData,selections)
}

function match(obesityData,selections){
    var totalcor = 0
    // note that when you append to corstatelist, you must append with a space in front of the name
    for (x of obesityData) {
        if (qScale(x.act) == qScale(x[selections]))
            totalcor = totalcor + 1
    }
    svg3.append("text")
        .attr("x", w)
        .attr("y", th/2)
        .attr("class","temp")
        .attr("text-anchor", "middle")
        .text("You predicted "+totalcor+"/50 states correctly.")
        .style("fill", "white");
}

</script>
</body>
</html>
